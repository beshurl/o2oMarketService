<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.o2omystore.dao.CouponDao">

	<resultMap id="couponResultMap" type="com.ssafy.o2omystore.dto.Coupon">
		<id property="couponId" column="coupon_id" />
		<result property="userId" column="user_id" />
		<result property="couponType" column="coupon_type" />
		<result property="discountValue" column="discount_value" />
		<result property="validFrom" column="valid_from" />
		<result property="validTo" column="valid_to" />
		<result property="used" column="is_used" />
		<result property="usedAt" column="used_at" />
		<result property="createdAt" column="created_at" />
	</resultMap>

	<select id="selectCouponsByUserId" resultMap="couponResultMap" parameterType="string">
		SELECT
		coupon_id,
		user_id,
		coupon_type,
		discount_value,
		valid_from,
		valid_to,
		is_used,
		used_at,
		created_at
		FROM coupon
		WHERE user_id = #{value}
		ORDER BY created_at DESC
	</select>

	<select id="countAvailableCouponsByUserId" parameterType="string" resultType="int">
		SELECT COUNT(*)
		FROM coupon
		WHERE user_id = #{value}
		AND is_used = 0
		AND NOW() BETWEEN valid_from AND valid_to
	</select>
</mapper>
