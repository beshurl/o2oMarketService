<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.o2omystore.dao.OrderDao">

	<resultMap id="orderMap"
		type="com.ssafy.o2omystore.dto.Order">
		<id property="orderId" column="order_id" />
		<result property="userId" column="user_id" />
		<result property="orderTime" column="order_time" />
		<result property="status" column="status" />
		<result property="recipientName" column="recipient_name" />
		<result property="phone" column="phone" />
		<result property="address" column="address" />
		<result property="addressDetail" column="address_detail" />
		<result property="zipCode" column="zip_code" />
		<result property="productTotal" column="product_total" />
		<result property="deliveryFee" column="delivery_fee" />
		<result property="discount" column="discount" />
		<result property="usedPoints" column="used_points" />
		<result property="couponDiscount" column="coupon_discount" />
		<result property="couponId" column="coupon_id" />
		<result property="totalPrice" column="total_price" />
		<result property="paymentMethod" column="payment_method" />
		<result property="carrier" column="carrier" />
		<result property="trackingNumber" column="tracking_number" />
		<result property="estimatedDate" column="estimated_date" />
		<collection property="orderDetails"
			ofType="com.ssafy.o2omystore.dto.OrderDetail"
			column="order_id"
			select="selectOrderDetailByOrderId" />
	</resultMap>

	<insert id="insertOrder"
		parameterType="com.ssafy.o2omystore.dto.Order"
		useGeneratedKeys="true"
		keyProperty="orderId">
		INSERT INTO orders (
		user_id,
		order_time,
		status,
		zip_code,
		product_total,
		delivery_fee,
		discount,
		used_points,
		coupon_discount,
		coupon_id,
		total_price,
		payment_method,
		carrier,
		tracking_number,
		estimated_date
		) VALUES (
		#{userId},
		NOW(),
		#{status},
		#{zipCode},
		#{productTotal},
		#{deliveryFee},
		#{discount},
		#{usedPoints},
		#{couponDiscount},
		#{couponId},
		#{totalPrice},
		#{paymentMethod},
		#{carrier},
		#{trackingNumber},
		#{estimatedDate}
		)
	</insert>
	<insert id="insertOrderDetail"
		parameterType="list"> INSERT INTO order_detail ( order_id, product_id,
		quantity, price, discount_applied ) VALUES <foreach
			collection="orderDetails"
			item="detail"
			separator=",">
			(
			#{detail.orderId},
			#{detail.productId},
			#{detail.quantity},
			#{detail.price},
			#{detail.discountApplied}
			)
		</foreach>
	</insert>

	<select id="selectAllOrder" resultMap="orderMap">
		select
		o.order_id,
		o.user_id,
		o.order_time,
		o.status,
		u.name as recipient_name,
		u.phone as phone,
		u.address as address,
		u.address_detail as address_detail,
		o.zip_code,
		o.product_total,
		o.delivery_fee,
		o.discount,
		o.used_points,
		o.coupon_discount,
		o.coupon_id,
		o.total_price,
		o.payment_method,
		o.carrier,
		o.tracking_number,
		o.estimated_date
		from orders o
		join user u on o.user_id = u.user_id
		order by o.order_id desc
		;
	</select>
	<resultMap id="orderDetailMap"
		type="com.ssafy.o2omystore.dto.OrderDetail">
		<id property="orderItemId" column="order_item_id" />
		<result property="orderId" column="order_id" />
		<result property="productId" column="product_id" />
		<result property="quantity" column="quantity" />
		<result property="price" column="price" />
		<result property="discountApplied" column="discount_applied" />
	</resultMap>
	<select id="selectOrderDetailByOrderId"
		resultMap="orderDetailMap"
		parameterType="Integer">
		select * from order_detail where order_id = #{orderId}
	</select>

	<select id="selectOrdersByUserId"
		resultMap="orderMap">
		select
		o.order_id,
		o.user_id,
		o.order_time,
		o.status,
		u.name as recipient_name,
		u.phone as phone,
		u.address as address,
		u.address_detail as address_detail,
		o.zip_code,
		o.product_total,
		o.delivery_fee,
		o.discount,
		o.used_points,
		o.coupon_discount,
		o.coupon_id,
		o.total_price,
		o.payment_method,
		o.carrier,
		o.tracking_number,
		o.estimated_date
		from orders o
		join user u on o.user_id = u.user_id
		where o.user_id = #{userId}
		order by o.order_id desc
	</select>
	<select id="selectOrderById"
		resultMap="orderMap">
		select
		o.order_id,
		o.user_id,
		o.order_time,
		o.status,
		u.name as recipient_name,
		u.phone as phone,
		u.address as address,
		u.address_detail as address_detail,
		o.zip_code,
		o.product_total,
		o.delivery_fee,
		o.discount,
		o.used_points,
		o.coupon_discount,
		o.coupon_id,
		o.total_price,
		o.payment_method,
		o.carrier,
		o.tracking_number,
		o.estimated_date
		from orders o
		join user u on o.user_id = u.user_id
		where o.order_id = #{orderId}
	</select>
	<update id="updateOrderStatus">
		update orders
		set status = #{status}
		where order_id = #{orderId}
	</update>
	<delete id="deletelOrders">
		delete from orders
		where order_id = #{orderId}
	</delete>
	<select id="countOrdersByUserId" parameterType="string" resultType="int">
		select count(*)
		from orders
		where user_id = #{value}
	</select>
	<select id="countInProgressOrdersByUserId" parameterType="string"
		resultType="int">
		select count(*)
		from orders
		where user_id = #{value}
		and status in ('PENDING', 'PROCESSING', 'SHIPPING')
	</select>
</mapper>
